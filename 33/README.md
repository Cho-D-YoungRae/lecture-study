# [실습으로 배우는 선착순 이벤트 시스템](https://www.inflearn.com/course/선착순-이벤트-시스템-실습/dashboard)

> [github](https://github.com/ZeroCho/next-app-router-z)

-[ ] 2024/05/10 ~ ing

## Redis 를 활용하여 문제 해결하기

### 문제점 해결하기

우리가 원하는 것은 쿠폰 개수에 대한 정합성인데 락을 활용하여 구현한다면 발급된 쿠폰 개수를 가져오는 것 부터 쿠폰을 생성할 때까지 락을 걸어야 함

락을 걸어야 하는 구간이 길어져서 성능에 불이익이 있을 수 있음

> 레디스의 incr 사용

### 문제점

발급하는 쿠폰의 개수가 많아질 수록 rdb 에 부하를 주게 됨

이 db 가 쿠폰전용 db 가 아니라면 다른 서비스에도 영향을 줄 수 있음

> 카프카를 이용해서 문제 해결 가능
>
> Kafka 미사용시 주문생성/회원가입요청의 타임아웃 및 10분뒤 실행에 대한 해결책으로 Kafka 를 선택한 이유는 배압조절(back pressure) 때문입니다.

## 발급가능한 쿠폰개수를 1인당 1개로 제한하기

디비에 쿠폰 타입과 유저 아이디로 유니크 키를 걸어서 해결

> 모든 쿠폰 타입이 유저마다 1개로 제한되는 것은 아니므로 이 방법은 사용하기 어려움

범위로 락을 잡고 쿠폰 발급 여부를 판단 후 발급 됐다면 발급 안하기

> 현재 실제 쿠폰 발급은 consumer 에서 진행되고 있고 시간 차가 있어서 1개 보다 많이 발급될 수 있음
>
> api 에서 직접 쿠폰을 발급한다고 하면, 락 범위가 너무 넓어지고(조회부터 발급까지) 성능 이슈가 발생할 수 있음
>
> redis 의 set 자료구조를 이용할 수 있음

## 쿠폰을 발급하다가 에러가 발생하면 어떻게 하나요 ?

컨슈머에서 토픽의 데이터를 가져가서 쿠폰을 발급하다가 에러가 발생하면 쿠폰은 발급되지 않았는데 쿠폰 개수만 증가하는 상황이 발생 -> 지정된 개수(100개)보다 적은 쿠폰이 발급됨

여러가지 대처방안이 있지만 여기서는 오류가 발생하면 백업 데이터와 로그를 남기는 방식 구현

# Ep.22 커넥션 관리

## 커넥션 메모리 사용량

- 오라클이나 postgresql 과 달리 프로세스 기반이 아니라, 스레드 기반
  - 다른 dbms 에 비해 커넥션당 메모리 사용량이 낮은 편
- 일반적으로 커넥션 당 16KB ~ 3MB 메모리 사용
- 커넥션 당 CPU, 메모리 사용량 증가가 스레드가 많을 수록 적어짐
  - Server side ThreadPool on AWS Aurora
  - 클라이언트가 보낸 쿼리는 전용의 커넥션을 통해서 서버로 전달이 되지만, 일부 버전의 MySQL 서버에서는 커넥션 별로 쿼리를 처리하는 전용 스레드가 있는 것이 아니라 공유 스레드(ThreadPool)가 쿼리를 처리
- 그래도 커넥션이 매우 많아질 수 있으니 여전히 조심해야함

## 최대 커넥션 설정

- Server-side Max(max_connections)
  - MySQL: 최대 8k ~ 10k
    - 최대 설정과 달리 적절한 값을 설정해야함
  - c.f.) PostgreSQL: 3k ~ 5k (프로세스별 점유 메모리 크고, linus page cache 필요)
  - MySQL 연결 처리 및 스레드는 가볍지만, 많으면 부담

## 커넥션 풀 설정

### Client-side Pool Max (connection)

- 일반적으로 요즘 앱서버들은 커넥션 풀을 사용하도록 구현되어 있음
- 많은 경우 커넥션 풀의 목적을 성능 개선에만 집중하는 경우도 있는데
- 커넥션 풀은 쿼리 실행 시점에 커넥션을 열고 닫는 오버헤드를 줄이기도 하지만
- 앱서버의 모든 요청들이 제한된 커넥션을 서로 공유하면서 MySQL 서버와의 커넥션을 최소화 하는 목적도 있음
- 응용 프로그램의 특성에 따라서 상이하지만,
- 커넥션 풀 사용 필수 & 시작 설정은 Max 20~30
  - 최대 커넥션을 매우 높은 값으로 시작하는 경우도 많음.. 하지만 처음부터 이렇게 높은 값으로 설정하면, 낮은 값으로 튜닝이 쉽지 않음
    - 예를 들면, 코어 2개 짜리에서 커넥션 200
- Min = Max \* (70% ~ 90%)
  - min = max 설정이 성능상 좋지만, 커넥션 부족 현상 판단 어려움
  - MySQL 서버의 커넥션 = 최대 인지 아닌지 확인 -> 최대를 늘려야 할지 판단
    - MySQL 에서는 각 클라이언트의 ip 별로 연결된 커넥션의 개수를 확인할 수 있음
- 앱 서버가 100개 이고, MAX(ConnectionPool) = 200 이면 20K 커넥션 필요
  - 요즘은 k8s 환경이 일반화 되면서 서비스 하나당 파드가 여러개인 경우가 많은데 파드당 커넥션 설정을 많이 주게되면, MySQL 서버에서는 너무 많은 커넥션을 사용해야함
- (필요시, 커넥션이 늘어나는 것을 피할 수 없다면) 미들웨어를 이용한 서버사이드 커넥션 재활용

### Connect Timeout 설정

- Connection Open 또는 Connection Pool 에서 커넥션을 가져오는 시간
  - 커넥션 풀에 커넥션이 없으면 MySQL 서버로 커넥션을 생성할 떄 걸리는 시간도 포함
- 밀리초 이하의 값 설정 권장하지 않음
  - 커넥션 풀에서 가용 커넥션이 있어서 MySQL 서버로 커넥션을 새로 생성하지 않아도 되는 경우는 괜찮을 수 있지만...
  - 커넥션을 새로 생성해야 하는 경우에는 1초 이내의 처리가 불가능할 수도 있음
- 인프라 여건에 맞춰서 3~10초 정도의 시간 설정 사용
  - 커넥션을 가져오지 못할 경우, 일반적으로 다른 Fallback 전략이 없음
  - 일시적인 디비 서버 과부하시, 커넥션 요청 및 취소 반복으로 오히려 부가적인 자원 소모
  - 커넥션 가져오기 실패시, 사용자에게 오류 화면을 보내는 경우라면 타임아웃을 짧게 할 수 있음

### Query Timeout 설정

- Query Timeout 시, 취소 및 동일 쿼리 재요청시 오히려 디비 서버의 부담 가중
- Query Timeout 시, 쿼리 재요청을 하지 않는다면 Timeout 짧게 할 수 있음

### Idle Timeout 설정

> 일정 시간동안 아무런 쿼리를 실행하지 않는 유휴 커넥션을 정리하는 설정

- 커넥션풀 사용시 자주 발생하는 에러
- 커넥션 풀에 오랜 시간동안 방치되어있던 커넥션이 앱서버 외부의 원인으로 인해서 끊어져 버린 경우 이것을 회피하기 위한 목적을 가짐
- 에러 회피를 위해서 Idle Connection Timeout 을 매우 짧게 설정 (e.g. ~ 60 seconds) -> 권장하지 않음
  - DBMS 서버 커넥션은 이렇게 짧게 사용하고 버리는 자원 아님
  - MySQL 서버에서 커넥션을 생성하는 자원 소모, prepare statement 와 같이 커넥션 하위에 캐시되어 있는 데이터가 한번에 사라짐
- 커넥션은 한번 생성되면 최대한 오래 사용하는 것이 좋음
- 최소 20~30분 이상 설정 권장
- 에러 회피를 위해서 Pool의 Connection Validation 기능 최대한 활용
  - MySQL 서버에서도 가볍게 상태 체크를 할 수 있도록 기능이 개선됨
- 어떤 방법으로 보완하더라도 끊어진 커넥션으로 인한 에러는 발생 가능
- 주요 기능의 경우, Retry 로직 구현 권장

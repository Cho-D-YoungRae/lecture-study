# Ep.17 SELECT ... FOR UPDATE [ NOWAIT | SKIP LOCKED ]

## select ... for update nowait

- 잠금 대상 레코드가 이미 다른 세션에 의해 잠겨있는 경우, 잠금을 대기하는 것이 아니라 바로 에러를 반환
- innodb_lock_wait_timeout 옵션을 0으로 설정한 것과 유사한 효과
  - 기본값은 50
  - 실제로 0으로 설정 가능한 것은 아님 (1이상으로 가능)
  - 일반 개발자가 이 옵션을 다루지는 않을 것
- 트랜잭션 내에서 nowait 쿼리를 실행하여 에러가 반환되더라도, 열어둔 트랜잭션을 그대로 유지됨
  - 명시적으로 커밋이나 롤백을 해야함

## select ... for update skip locked

- 잠금 대상 레코드 중에 다른 세션에 의해 이미 잠금이 걸려있는 레코드는 스킵하고, 잠금이 걸려있지 않은 레코드를 잠그고 반환
- 따라서 잠금 대상 레코드가 비결정적(non-deterministic)으로 정해짐(즉, 쿼리 실행 시 어떤 레코드가 잠금이 걸릴지 예측하기 어려움)
- 잠금 대상 레코드들이 모두 잠금이 걸려있는 경우에는 빈 결과를 반환
  - 반환되는 결과 데이터는 없다하더라도, 경우에 따라 Gap-Lock 을 점유할 수 있음
- `order by` & `limit` 절과 함께 많이 사용됨

## nowait & skip locked with join

- join 되는 모든 레코드 잠금됨
- 특정 테이블만 변경할 예정이라면 of 구문을 통해 해당 테이블만 잠금할 수 있음
  - `for update of <table> skip locked`

## 정리

- nowait 와 skip locked 를 사용하면, `select ... for update` 로만 사용할 때보다 동시 처리 성능을 높이고 DB 서버 자원을 좀 더 효율적으로 사용할 수 있음
- nowait 은 잠금 대기가 발생하는 경우 비즈니스 로직적으로 비정상적인 경우이며, 이 경우 굳이 잠금을 대기하지 않고 바로 빠르게 에러 처리되기를 원하는 경우 사용 가능
- skip locked 는 선착순 쿠폰 발급이나, 데이터 큐잉 후 배치잡 처리 등에 유용하게 사용 가능
